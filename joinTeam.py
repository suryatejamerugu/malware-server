from selenium import webdriver
import time
from selenium.webdriver.common.keys import Keys
from datetime import datetime

from common import Wait
Sleep_time = 2
error_count = 10

def JoinTeam(browser,team_card_elemet,start_time,end_time):
    try:
        team_card_elemet.click()
    except:
        print("Error in Clicking in Team in joinTeam")
        quit()
    Wait(Sleep_time*3)


    #clicking in join-1 button
    e_c = 0
    while True:
        try:
            join_buttons = browser.find_elements_by_tag_name("calling-join-button")
        except:
            e_c += 1
            if e_c > error_count:
                print("Join_team: Error in getting join-1 buttons")
                quit()
            Wait(Sleep_time)
            continue
        if(len(join_buttons)> 1):
            print("More than one Meating in the team")
        join_buttons[-1].find_elements_by_tag_name("button")[0].click()
        print("Join-1 Button Clicked")
        Wait(Sleep_time)
        break

    #Clecking For alerts
    try:
        browser.switch_to_alert().accept()
    except:
        print("Join_team: No alert")

    #Turn offing Cemera and mic
    e_c = 0
    while True:
        try:
            cms = browser.find_elements_by_tag_name("toggle-button")
        except:
            e_c += 1
            if e_c > error_count:
                print("Join_team: Error in getting Camera and mic buttons")
                quit()
            Wait(Sleep_time)
            continue
        for toggle in cms:
            state = toggle.get_attribute("title")
            if (state == "Turn camera off") or (state == "Mute microphone"):
                toggle.click()
                Wait(Sleep_time)
        break

    #Clicking on the Join-2 button
    e_c = 0
    while (True):
        join = browser.find_elements_by_class_name("button-col")
        if (len(join) == 0):
            e_c += 1
            if e_c > error_count:
                print("Some thing got wrong in Getting join-2 button.....")
                quit()
            Wait(Sleep_time)
            continue
        join[0].click()
        break

    while(True):
        nh, nm = datetime.now().time().hour, datetime.now().time().minute
        now_time = ""
        if nh < 10:
            now_time += str(nh) + ":"
        else:
            now_time += str(nh) + ":"
        if nm < 10:
            now_time += str(nm)
        else:
            now_time += str(nm)

        if(now_time > end_time):
            browser.find_element_by_class_name("ts-calling-screen").click()

            browser.find_element_by_xpath('//*[@id="teams-app-bar"]/ul/li[3]').click()
            time.sleep(1)

            browser.find_element_by_xpath('//*[@id="hangup-button"]').click()

            browser.find_element_by_class_name("school-app-back-button").click()
            break
        time.sleep(5)



