from typing import Dict, Any

import firebase_admin
from firebase_admin import credentials,auth,db
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
import threading
import time
from Sheduler import Get_present_Team_element
from joinTeam import JoinTeam

from login import login
import data
data.init()
print("hii")
cred = credentials.Certificate("malware-credentials.json")
app = firebase_admin.initialize_app(cred , {
    "databaseURL" : "https://malware-d8758-default-rtdb.firebaseio.com/"
})

options = Options()
options.add_argument("--use-fake-ui-for-media-stream")

INITIAL_URL = "https://go.microsoft.com/fwlink/p/?LinkID=873020&clcid=0x4009&culture=en-in&country=IN&lm=deeplink&lmsrc=homePageWeb&cmpid=WebSignIn"


def serverStateListener(res):
    currentStates = dict(db.reference("/serverState").get())

    for i in currentStates.keys():
        if i in data.current_users:
            if currentStates[i]['value'] == False:
                print("Server Stoped for " + i)
                data.current_users.remove(i)
        else:
            if currentStates[i]['value'] == True:
                data.current_users.append(i)
                print("Server Started for "+ i)
                t1 = threading.Thread(target=StartInstance , args=(i,))
                t1.start()



def StartInstance(uid):
    acc = db.reference("/users/"+uid+"/accounts").get()
    print(acc)
    if(acc == None):
        print("User Account Not Found")
    else:
        status_msg = db.reference("/serverState/"+uid+"/msg")
        status_msg.set("Staring Server.....")
        browser = webdriver.Chrome("./chromedriver.exe",options=options)
        login(browser,INITIAL_URL,acc['email'],acc['passowrd'],uid)
        print("Instatnce Created")
        while(uid in data.current_users):
            print(data.current_users)
            status_msg.set("Getting Shedules")
            time_table = db.reference("/users/"+uid+"/shedule").get()
            if(not time_table):
                status_msg.set("No Shedule Found")
                time.sleep(10)
                continue
            status_msg.set("Shedule Found")
            e = Get_present_Team_element(browser,time_table)
            if(type(e) == type(str())):
                status_msg.set("No Current Meetings")
                time.sleep(10)
                continue
            team, team_name, start_time, end_time = e
            status_msg.set("Joining in "+team_name)
            JoinTeam(browser,team,start_time,end_time)
        browser.close()


r = db.reference("/serverState")
r.listen(serverStateListener)

